<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقارير المناشط</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;500;600;700;800&family=Material+Icons+Round" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#2D6A4F',
                        'primary-light': '#BDD5C4',
                        'primary-lighter': '#E8F3EC',
                        accent: '#FF8B8B',
                        'accent-light': '#FFD4D4',
                        surface: '#FFFFFF',
                        'surface-dark': '#1E1E2E',
                        'bg': '#F0F2F5',
                        'bg-dark': '#141420',
                        'card-dark': '#252538',
                        'text-primary': '#1A1A2E',
                        'text-secondary': '#6B7280',
                    },
                    fontFamily: {
                        sans: ['Noto Sans Arabic', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    
    <style>
        body { 
            font-family: 'Noto Sans Arabic', sans-serif; 
            background: #F0F2F5;
        }
        .dark body { background: #141420; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #BDD5C4; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #2D6A4F; }
        .ios-blur { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        
        /* === الأنيميشن === */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.92); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(45, 106, 79, 0.15); }
            50% { box-shadow: 0 0 0 8px rgba(45, 106, 79, 0); }
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-card {
            animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }
        .animate-scale {
            animation: fadeInScale 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }
        .animate-slide {
            animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }
        
        /* === كروت KPI === */
        .kpi-card {
            position: relative;
            overflow: hidden;
            transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .kpi-card:active {
            transform: scale(0.97);
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            border-radius: 0 0 0 80px;
            opacity: 0.08;
            transition: all 0.3s;
        }
        .kpi-card:nth-child(1)::before { background: #2D6A4F; }
        .kpi-card:nth-child(2)::before { background: #FF8B8B; }
        .kpi-card:nth-child(3)::before { background: #F59E0B; }
        .kpi-card:nth-child(4)::before { background: #3B82F6; }
        
        .kpi-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            transition: transform 0.3s;
        }
        .kpi-card:active .kpi-icon {
            transform: scale(1.1);
        }
        
        /* === كروت المخططات === */
        .chart-card {
            background: white;
            border-radius: 20px;
            border: 1px solid rgba(189, 213, 196, 0.2);
            transition: all 0.35s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
        }
        .dark .chart-card {
            background: #252538;
            border-color: rgba(255,255,255,0.06);
        }
        .chart-card:active {
            transform: scale(0.985);
        }
        
        /* === الفلتر === */
        .filter-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%232D6A4F' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 8px center;
            background-size: 18px;
            padding-left: 28px;
            transition: all 0.2s;
        }
        .filter-select:focus {
            box-shadow: 0 0 0 3px rgba(45, 106, 79, 0.15);
        }
        
        /* === شريط التقدم === */
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background: #F0F2F5;
            overflow: hidden;
        }
        .dark .progress-bar { background: #1E1E2E; }
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1.2s cubic-bezier(0.16, 1, 0.3, 1);
            width: 0;
        }
        
        /* === Loading skeleton === */
        .skeleton {
            background: linear-gradient(90deg, #e8ede9 25%, #d5ddd7 50%, #e8ede9 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        .dark .skeleton {
            background: linear-gradient(90deg, #2a2a3a 25%, #353548 50%, #2a2a3a 75%);
            background-size: 200% 100%;
        }
        
        /* === Badge === */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            padding: 2px 8px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
        }
        .badge-up { background: #E8F3EC; color: #2D6A4F; }
        .badge-down { background: #FFE8E8; color: #D32F2F; }
        .dark .badge-up { background: rgba(45, 106, 79, 0.2); color: #7BC89C; }
        .dark .badge-down { background: rgba(255, 139, 139, 0.15); color: #FF8B8B; }
        
        /* Section divider */
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }
        .section-header .line {
            flex: 1;
            height: 1px;
            background: linear-gradient(to left, transparent, #BDD5C4, transparent);
        }
        .dark .section-header .line {
            background: linear-gradient(to left, transparent, rgba(45, 106, 79, 0.3), transparent);
        }
    </style>
</head>
<body class="bg-bg dark:bg-bg-dark text-text-primary dark:text-slate-100 min-h-screen pb-28">

    <script>
        const DATA_ENDPOINT = 'https://n8n.smoo1.com/webhook/manashet-data';
        const REFRESH_INTERVAL = 30000;
        let activities = [];
        
        const shortNames = {
            'الشريعة والفقه والعبادات': 'الشريعة',
            'التوحيد والعقيدة': 'التوحيد',
            'الأخلاق والسلوك والأداب': 'الأخلاق',
            'الأمن الفكري والفكر المعتدل': 'الأمن الفكري'
        };
        
        const classColors = {
            'الشريعة والفقه والعبادات': '#2D6A4F',
            'التوحيد والعقيدة': '#FF8B8B',
            'الأخلاق والسلوك والأداب': '#64748B',
            'الأمن الفكري والفكر المعتدل': '#F59E0B'
        };
    </script>

    <!-- ==================== الهيدر ==================== -->
    <header class="px-5 pt-14 pb-3 sticky top-0 z-30 bg-bg/80 dark:bg-bg-dark/80 ios-blur">
        <div class="flex justify-between items-center">
            <div class="animate-slide">
                <h1 class="text-2xl font-extrabold text-text-primary dark:text-white">التقارير</h1>
                <p class="text-xs text-text-secondary dark:text-slate-400 mt-0.5">تحليل شامل · تحديث تلقائي</p>
            </div>
            <div class="flex items-center gap-3">
                <div id="refresh-indicator" class="hidden">
                    <div class="w-8 h-8 rounded-full bg-primary-lighter dark:bg-primary/20 flex items-center justify-center">
                        <span class="material-icons-round text-primary animate-spin text-lg">sync</span>
                    </div>
                </div>
                <button id="refresh-btn" onclick="loadData()" class="w-9 h-9 rounded-xl bg-surface dark:bg-card-dark shadow-sm flex items-center justify-center border border-primary-light/20 dark:border-white/5 transition-transform active:scale-90">
                    <span class="material-icons-round text-text-secondary dark:text-slate-400 text-lg">refresh</span>
                </button>
                <button onclick="toggleDarkMode()" class="w-9 h-9 rounded-xl bg-surface dark:bg-card-dark shadow-sm flex items-center justify-center border border-primary-light/20 dark:border-white/5 transition-transform active:scale-90">
                    <span class="material-icons-round text-text-secondary dark:text-slate-400 text-lg">dark_mode</span>
                </button>
            </div>
        </div>
    </header>

    <!-- ==================== المحتوى ==================== -->
    <main class="px-5 space-y-5 mt-2">
        
        <!-- ========== بطاقات KPI ========== -->
        <div class="grid grid-cols-2 gap-3">
            <!-- المستفيدين -->
            <div class="kpi-card bg-surface dark:bg-card-dark rounded-2xl p-4 shadow-sm border border-primary-light/15 dark:border-white/5 animate-card" style="animation-delay: 0.05s">
                <div class="flex items-center justify-between mb-3">
                    <div class="kpi-icon bg-primary-lighter dark:bg-primary/15">
                        <span class="material-icons-round text-primary">groups</span>
                    </div>
                    <span class="badge badge-up">
                        <span class="material-icons-round" style="font-size:12px">trending_up</span>
                        نشط
                    </span>
                </div>
                <span id="kpi-beneficiaries" class="text-2xl font-extrabold text-text-primary dark:text-white block">0</span>
                <span class="text-[11px] text-text-secondary dark:text-slate-400 mt-0.5 block">إجمالي المستفيدين</span>
            </div>
            
            <!-- المناشط -->
            <div class="kpi-card bg-surface dark:bg-card-dark rounded-2xl p-4 shadow-sm border border-primary-light/15 dark:border-white/5 animate-card" style="animation-delay: 0.12s">
                <div class="flex items-center justify-between mb-3">
                    <div class="kpi-icon bg-accent-light/40 dark:bg-accent/15">
                        <span class="material-icons-round text-accent">event</span>
                    </div>
                    <span class="badge badge-up">
                        <span class="material-icons-round" style="font-size:12px">trending_up</span>
                        نشط
                    </span>
                </div>
                <span id="kpi-activities" class="text-2xl font-extrabold text-text-primary dark:text-white block">0</span>
                <span class="text-[11px] text-text-secondary dark:text-slate-400 mt-0.5 block">عدد المناشط</span>
            </div>
            
            <!-- المنفذين -->
            <div class="kpi-card bg-surface dark:bg-card-dark rounded-2xl p-4 shadow-sm border border-primary-light/15 dark:border-white/5 animate-card" style="animation-delay: 0.19s">
                <div class="flex items-center justify-between mb-3">
                    <div class="kpi-icon bg-amber-50 dark:bg-amber-500/15">
                        <span class="material-icons-round text-amber-500">person</span>
                    </div>
                </div>
                <span id="kpi-executors" class="text-2xl font-extrabold text-text-primary dark:text-white block">0</span>
                <span class="text-[11px] text-text-secondary dark:text-slate-400 mt-0.5 block">عدد المنفذين</span>
            </div>
            
            <!-- المتوسط -->
            <div class="kpi-card bg-surface dark:bg-card-dark rounded-2xl p-4 shadow-sm border border-primary-light/15 dark:border-white/5 animate-card" style="animation-delay: 0.26s">
                <div class="flex items-center justify-between mb-3">
                    <div class="kpi-icon bg-blue-50 dark:bg-blue-500/15">
                        <span class="material-icons-round text-blue-500">avg_pace</span>
                    </div>
                </div>
                <span id="kpi-avg" class="text-2xl font-extrabold text-text-primary dark:text-white block">0</span>
                <span class="text-[11px] text-text-secondary dark:text-slate-400 mt-0.5 block">متوسط المستفيدين</span>
            </div>
        </div>

        <!-- ========== نظرة على التوزيع ========== -->
        <div class="section-header animate-card" style="animation-delay: 0.3s">
            <span class="text-xs font-bold text-text-secondary dark:text-slate-500 uppercase tracking-wider">نظرة على التوزيع</span>
            <div class="line"></div>
        </div>
        
        <!-- الدائري + شريط التصنيفات -->
        <div class="grid grid-cols-1 gap-4">
            <div class="chart-card p-5 animate-card" style="animation-delay: 0.35s">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-sm flex items-center gap-2">
                        <div class="w-7 h-7 rounded-lg bg-primary-lighter dark:bg-primary/15 flex items-center justify-center">
                            <span class="material-icons-round text-primary text-base">pie_chart</span>
                        </div>
                        توزيع التصنيفات
                    </h3>
                    <span class="text-[10px] text-text-secondary dark:text-slate-500 bg-bg dark:bg-bg-dark px-2 py-1 rounded-lg">حسب المستفيدين</span>
                </div>
                <div id="pieChart"></div>
                <!-- أشرطة التقدم -->
                <div id="classification-bars" class="space-y-3 mt-4 pt-4 border-t border-slate-100 dark:border-white/5"></div>
            </div>
        </div>

        <!-- ========== تحليل الأداء ========== -->
        <div class="section-header animate-card" style="animation-delay: 0.4s">
            <span class="text-xs font-bold text-text-secondary dark:text-slate-500 uppercase tracking-wider">تحليل الأداء</span>
            <div class="line"></div>
        </div>

        <!-- مخطط الخط -->
        <div class="chart-card p-5 animate-card" style="animation-delay: 0.45s">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-sm flex items-center gap-2">
                    <div class="w-7 h-7 rounded-lg bg-primary-lighter dark:bg-primary/15 flex items-center justify-center">
                        <span class="material-icons-round text-primary text-base">trending_up</span>
                    </div>
                    تحليل الحضور
                </h3>
                <select id="lineChartFilter" onchange="updateLineChart()" class="filter-select text-xs bg-bg dark:bg-bg-dark rounded-xl px-3 py-2 border border-primary-light/20 dark:border-white/8 focus:ring-2 focus:ring-primary font-medium text-text-primary dark:text-slate-200">
                    <option value="byDate">حسب التاريخ</option>
                    <option value="byClassification">حسب التصنيف</option>
                    <option value="byCategory">حسب فئة البرنامج</option>
                    <option value="byType">حضوري vs عن بعد</option>
                </select>
            </div>
            <div id="lineChart"></div>
        </div>

        <!-- ========== المقارنات ========== -->
        <div class="section-header animate-card" style="animation-delay: 0.5s">
            <span class="text-xs font-bold text-text-secondary dark:text-slate-500 uppercase tracking-wider">المقارنات</span>
            <div class="line"></div>
        </div>

        <!-- مخطط الأعمدة -->
        <div class="chart-card p-5 animate-card" style="animation-delay: 0.55s">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-sm flex items-center gap-2">
                    <div class="w-7 h-7 rounded-lg bg-accent-light/40 dark:bg-accent/15 flex items-center justify-center">
                        <span class="material-icons-round text-accent text-base">bar_chart</span>
                    </div>
                    ترتيب المنفذين
                </h3>
                <select id="barChartFilter" onchange="updateBarChart()" class="filter-select text-xs bg-bg dark:bg-bg-dark rounded-xl px-3 py-2 border border-primary-light/20 dark:border-white/8 focus:ring-2 focus:ring-primary font-medium text-text-primary dark:text-slate-200">
                    <option value="topExecutors">أكثر المنفذين نشاطاً</option>
                    <option value="executorsBeneficiaries">المنفذين حسب المستفيدين</option>
                    <option value="audienceComparison">مقارنة الفئات المستهدفة</option>
                    <option value="categoryComparison">مقارنة فئات البرامج</option>
                </select>
            </div>
            <div id="barChart"></div>
        </div>

        <!-- ========== التحليل المتقدم ========== -->
        <div class="section-header animate-card" style="animation-delay: 0.6s">
            <span class="text-xs font-bold text-text-secondary dark:text-slate-500 uppercase tracking-wider">التحليل المتقدم</span>
            <div class="line"></div>
        </div>

        <div class="chart-card p-5 animate-card" style="animation-delay: 0.65s">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-sm flex items-center gap-2">
                    <div class="w-7 h-7 rounded-lg bg-blue-50 dark:bg-blue-500/15 flex items-center justify-center">
                        <span class="material-icons-round text-blue-500 text-base">insights</span>
                    </div>
                    مقارنة متقدمة
                </h3>
                <select id="advancedFilter" onchange="updateAdvancedChart()" class="filter-select text-xs bg-bg dark:bg-bg-dark rounded-xl px-3 py-2 border border-primary-light/20 dark:border-white/8 focus:ring-2 focus:ring-primary font-medium text-text-primary dark:text-slate-200">
                    <option value="classificationTrend">اتجاه التصنيفات عبر الوقت</option>
                    <option value="weekdayAnalysis">تحليل أيام الأسبوع</option>
                    <option value="cumulativeGrowth">النمو التراكمي</option>
                </select>
            </div>
            <div id="advancedChart"></div>
        </div>
        
        <!-- فراغ أسفل -->
        <div class="h-4"></div>

    </main>

    <!-- ==================== شريط التنقل ==================== -->
    <nav class="fixed bottom-0 left-0 right-0 bg-surface/90 dark:bg-surface-dark/90 ios-blur border-t border-primary-light/15 dark:border-white/5 z-40">
        <div class="flex justify-around items-center px-6 pt-2 pb-6">
            <a href="manashet-dashboard.html" class="flex flex-col items-center gap-0.5 text-text-secondary dark:text-slate-500 transition-colors">
                <span class="material-icons-round text-[22px]">dashboard</span>
                <span class="text-[10px] font-semibold">الرئيسية</span>
            </a>
            <a href="#" class="flex flex-col items-center gap-0.5 text-text-secondary dark:text-slate-500 transition-colors">
                <span class="material-icons-round text-[22px]">event_note</span>
                <span class="text-[10px] font-semibold">البرامج</span>
            </a>
            <a href="reports.html" class="flex flex-col items-center gap-0.5 text-primary relative">
                <div class="absolute -top-2 w-12 h-1 bg-primary rounded-full"></div>
                <span class="material-icons-round text-[22px]">analytics</span>
                <span class="text-[10px] font-bold">التقارير</span>
            </a>
            <a href="#" class="flex flex-col items-center gap-0.5 text-text-secondary dark:text-slate-500 transition-colors">
                <span class="material-icons-round text-[22px]">settings</span>
                <span class="text-[10px] font-semibold">الإعدادات</span>
            </a>
        </div>
    </nav>

    <!-- ==================== JavaScript ==================== -->
    <script>
        let pieChart = null;
        let lineChart = null;
        let barChart = null;
        let advancedChart = null;

        // ========== الوضع الداكن ==========
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            setTimeout(updateAllCharts, 150);
        }

        function isDarkMode() {
            return document.documentElement.classList.contains('dark');
        }

        function getChartColors() {
            return isDarkMode() 
                ? { text: '#8892A4', grid: '#2A2A3A', bg: 'transparent', cardBg: '#252538' }
                : { text: '#8892A4', grid: '#F0F2F5', bg: 'transparent', cardBg: '#ffffff' };
        }

        // ========== أرقام متحركة ==========
        function animateNumber(el, target) {
            const duration = 800;
            const start = parseInt(el.textContent.replace(/[^\d]/g, '')) || 0;
            const startTime = performance.now();
            
            function update(now) {
                const elapsed = now - startTime;
                const progress = Math.min(elapsed / duration, 1);
                // easeOutExpo
                const eased = progress === 1 ? 1 : 1 - Math.pow(2, -10 * progress);
                const current = Math.round(start + (target - start) * eased);
                el.textContent = current.toLocaleString('ar-SA');
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        // ========== حساب KPIs ==========
        function updateKPIs() {
            if (activities.length === 0) return;
            
            const total = activities.reduce((sum, a) => sum + a.beneficiaries, 0);
            const count = activities.length;
            const executors = [...new Set(activities.map(a => a.executor))].length;
            const avg = Math.round(total / count);
            
            animateNumber(document.getElementById('kpi-beneficiaries'), total);
            animateNumber(document.getElementById('kpi-activities'), count);
            animateNumber(document.getElementById('kpi-executors'), executors);
            animateNumber(document.getElementById('kpi-avg'), avg);
        }

        // ========== أشرطة التصنيفات ==========
        function updateClassificationBars() {
            if (activities.length === 0) return;
            
            const classData = {};
            activities.forEach(a => {
                classData[a.classification] = (classData[a.classification] || 0) + a.beneficiaries;
            });
            const total = Object.values(classData).reduce((a, b) => a + b, 0);
            const sorted = Object.entries(classData).sort((a, b) => b[1] - a[1]);
            
            const container = document.getElementById('classification-bars');
            container.innerHTML = sorted.map(([cls, val]) => {
                const pct = ((val / total) * 100).toFixed(1);
                const color = classColors[cls] || '#2D6A4F';
                const name = shortNames[cls] || cls;
                return `
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full flex-shrink-0" style="background:${color}"></div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-xs font-semibold truncate">${name}</span>
                                <span class="text-[11px] font-bold text-text-secondary dark:text-slate-400">${pct}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="background:${color}" data-width="${pct}%"></div>
                            </div>
                        </div>
                        <span class="text-[11px] font-bold text-text-primary dark:text-white w-12 text-left">${val.toLocaleString('ar-SA')}</span>
                    </div>
                `;
            }).join('');
            
            // تأخير بسيط لتفعيل الأنيميشن
            requestAnimationFrame(() => {
                setTimeout(() => {
                    container.querySelectorAll('.progress-fill').forEach(bar => {
                        bar.style.width = bar.dataset.width;
                    });
                }, 100);
            });
        }

        // ========== المخطط الدائري ==========
        function createPieChart() {
            if (activities.length === 0) return;
            const colors = getChartColors();
            
            const classData = {};
            activities.forEach(a => {
                classData[a.classification] = (classData[a.classification] || 0) + a.beneficiaries;
            });
            
            const labels = Object.keys(classData).map(c => shortNames[c] || c);
            const series = Object.values(classData);
            const chartClrs = Object.keys(classData).map(c => classColors[c] || '#2D6A4F');
            
            const options = {
                series: series,
                chart: {
                    type: 'donut', height: 240,
                    fontFamily: 'Noto Sans Arabic, sans-serif',
                    background: colors.bg,
                    animations: { enabled: true, easing: 'easeinout', speed: 1000, dynamicAnimation: { speed: 500 } }
                },
                labels: labels,
                colors: chartClrs,
                plotOptions: {
                    pie: {
                        donut: {
                            size: '60%',
                            labels: {
                                show: true,
                                name: { show: true, fontSize: '13px', color: colors.text, fontWeight: 600 },
                                value: { show: true, fontSize: '20px', fontWeight: 800, color: isDarkMode() ? '#fff' : '#1A1A2E',
                                    formatter: val => parseInt(val).toLocaleString('ar-SA')
                                },
                                total: {
                                    show: true, label: 'الإجمالي', fontSize: '11px', color: colors.text,
                                    formatter: w => w.globals.seriesTotals.reduce((a, b) => a + b, 0).toLocaleString('ar-SA')
                                }
                            }
                        }
                    }
                },
                legend: { show: false },
                dataLabels: { enabled: false },
                stroke: { show: true, width: 3, colors: [isDarkMode() ? '#252538' : '#ffffff'] },
                tooltip: {
                    theme: isDarkMode() ? 'dark' : 'light',
                    y: { formatter: val => val.toLocaleString('ar-SA') + ' مستفيد' }
                }
            };

            if (pieChart) pieChart.destroy();
            pieChart = new ApexCharts(document.getElementById('pieChart'), options);
            pieChart.render();
            
            updateClassificationBars();
        }

        // ========== مخطط الخط ==========
        function updateLineChart() {
            if (activities.length === 0) return;
            const filter = document.getElementById('lineChartFilter').value;
            const colors = getChartColors();
            let chartData = {};
            let chartType = 'area';
            
            switch(filter) {
                case 'byDate':
                    activities.forEach(a => {
                        const shortDate = a.date.split('/').slice(1).join('/');
                        chartData[shortDate] = (chartData[shortDate] || 0) + a.beneficiaries;
                    });
                    break;
                case 'byClassification':
                    activities.forEach(a => {
                        const name = shortNames[a.classification] || a.classification;
                        chartData[name] = (chartData[name] || 0) + a.beneficiaries;
                    });
                    chartType = 'bar';
                    break;
                case 'byCategory':
                    activities.forEach(a => {
                        chartData[a.category] = (chartData[a.category] || 0) + a.beneficiaries;
                    });
                    chartType = 'bar';
                    break;
                case 'byType':
                    activities.forEach(a => {
                        chartData[a.type] = (chartData[a.type] || 0) + a.beneficiaries;
                    });
                    chartType = 'bar';
                    break;
            }
            
            const categories = Object.keys(chartData);
            const series = Object.values(chartData);
            
            const options = {
                series: [{ name: 'المستفيدين', data: series }],
                chart: {
                    type: chartType, height: 240,
                    fontFamily: 'Noto Sans Arabic, sans-serif',
                    toolbar: { show: false },
                    background: colors.bg,
                    animations: { enabled: true, easing: 'easeinout', speed: 800, dynamicAnimation: { speed: 400 } }
                },
                colors: ['#2D6A4F'],
                fill: chartType === 'area' ? {
                    type: 'gradient',
                    gradient: { shadeIntensity: 1, opacityFrom: 0.35, opacityTo: 0.05, stops: [0, 90, 100] }
                } : { opacity: 0.9 },
                stroke: { curve: 'smooth', width: chartType === 'area' ? 3 : 0, lineCap: 'round' },
                plotOptions: chartType === 'bar' ? { bar: { borderRadius: 8, columnWidth: '55%' } } : {},
                dataLabels: { enabled: chartType === 'bar', style: { fontSize: '10px', fontWeight: 700 }, offsetY: -5, background: { enabled: false } },
                xaxis: {
                    categories: categories,
                    labels: { style: { colors: colors.text, fontSize: '10px', fontWeight: 500 }, rotate: -45 },
                    axisBorder: { show: false }, axisTicks: { show: false }
                },
                yaxis: { labels: { style: { colors: colors.text, fontSize: '10px' } } },
                grid: { borderColor: colors.grid, strokeDashArray: 0, padding: { top: -10 } },
                tooltip: { theme: isDarkMode() ? 'dark' : 'light', y: { formatter: val => val.toLocaleString('ar-SA') + ' مستفيد' } }
            };

            if (lineChart) lineChart.destroy();
            lineChart = new ApexCharts(document.getElementById('lineChart'), options);
            lineChart.render();
        }

        // ========== مخطط الأعمدة ==========
        function updateBarChart() {
            if (activities.length === 0) return;
            const filter = document.getElementById('barChartFilter').value;
            const colors = getChartColors();
            let chartData = {};
            
            switch(filter) {
                case 'topExecutors':
                    activities.forEach(a => { chartData[a.executor] = (chartData[a.executor] || 0) + 1; });
                    break;
                case 'executorsBeneficiaries':
                    activities.forEach(a => { chartData[a.executor] = (chartData[a.executor] || 0) + a.beneficiaries; });
                    break;
                case 'audienceComparison':
                    activities.forEach(a => {
                        a.audience.split(',').map(s => s.trim()).forEach(aud => {
                            chartData[aud] = (chartData[aud] || 0) + a.beneficiaries;
                        });
                    });
                    break;
                case 'categoryComparison':
                    activities.forEach(a => { chartData[a.category] = (chartData[a.category] || 0) + a.beneficiaries; });
                    break;
            }
            
            let sorted = Object.entries(chartData).sort((a, b) => b[1] - a[1]);
            if (filter === 'topExecutors' || filter === 'executorsBeneficiaries') sorted = sorted.slice(0, 8);
            
            const cats = sorted.map(([k]) => k.length > 16 ? k.substring(0, 16) + '…' : k);
            const seriesData = sorted.map(([, v]) => v);
            
            // تدرج ألوان أخضر
            const barColors = ['#1B4332','#2D6A4F','#40916C','#52B788','#74C69D','#95D5B2','#B7E4C7','#D8F3DC'];
            
            const options = {
                series: [{ name: filter.includes('Beneficiaries') || filter.includes('Comparison') ? 'المستفيدين' : 'المناشط', data: seriesData }],
                chart: {
                    type: 'bar', height: 300,
                    fontFamily: 'Noto Sans Arabic, sans-serif',
                    toolbar: { show: false },
                    background: colors.bg,
                    animations: { enabled: true, easing: 'easeinout', speed: 900 }
                },
                colors: barColors,
                plotOptions: { bar: { borderRadius: 8, horizontal: true, distributed: true, barHeight: '65%',
                    dataLabels: { position: 'top' }
                } },
                dataLabels: {
                    enabled: true,
                    textAnchor: 'start',
                    formatter: val => val.toLocaleString('ar-SA'),
                    style: { colors: ['#fff'], fontSize: '11px', fontWeight: 700 },
                    offsetX: 8
                },
                xaxis: { categories: cats, labels: { style: { colors: colors.text, fontSize: '10px' } }, axisBorder: { show: false }, axisTicks: { show: false } },
                yaxis: { labels: { style: { colors: isDarkMode() ? '#ccc' : '#444', fontSize: '11px', fontWeight: 600 } } },
                grid: { borderColor: colors.grid, strokeDashArray: 0, xaxis: { lines: { show: true } }, yaxis: { lines: { show: false } } },
                legend: { show: false },
                tooltip: { theme: isDarkMode() ? 'dark' : 'light' }
            };

            if (barChart) barChart.destroy();
            barChart = new ApexCharts(document.getElementById('barChart'), options);
            barChart.render();
        }

        // ========== المخطط المتقدم ==========
        function updateAdvancedChart() {
            if (activities.length === 0) return;
            const filter = document.getElementById('advancedFilter').value;
            const colors = getChartColors();
            let options = {};
            
            const baseChartConfig = {
                fontFamily: 'Noto Sans Arabic', toolbar: { show: false }, background: colors.bg,
                animations: { enabled: true, easing: 'easeinout', speed: 900 }
            };
            
            switch(filter) {
                case 'classificationTrend':
                    const dateClassData = {};
                    const allDates = [...new Set(activities.map(a => a.date))].sort();
                    const allClasses = [...new Set(activities.map(a => a.classification))];
                    
                    allClasses.forEach(cls => {
                        dateClassData[cls] = allDates.map(date => 
                            activities.filter(a => a.date === date && a.classification === cls)
                                .reduce((sum, a) => sum + a.beneficiaries, 0)
                        );
                    });
                    
                    options = {
                        series: allClasses.map(cls => ({ name: shortNames[cls] || cls, data: dateClassData[cls] })),
                        chart: { ...baseChartConfig, type: 'line', height: 260 },
                        colors: Object.values(classColors),
                        stroke: { curve: 'smooth', width: 2.5 },
                        markers: { size: 3, strokeWidth: 0 },
                        xaxis: { categories: allDates.map(d => d.split('/').slice(1).join('/')), labels: { style: { colors: colors.text, fontSize: '9px' }, rotate: -45 }, axisBorder: { show: false }, axisTicks: { show: false } },
                        yaxis: { labels: { style: { colors: colors.text, fontSize: '10px' } } },
                        grid: { borderColor: colors.grid, strokeDashArray: 0 },
                        legend: { position: 'top', fontSize: '10px', fontWeight: 600, labels: { colors: isDarkMode() ? '#ccc' : '#555' }, markers: { radius: 3 } },
                        tooltip: { theme: isDarkMode() ? 'dark' : 'light' }
                    };
                    break;
                    
                case 'weekdayAnalysis':
                    const weekdays = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                    const weekdayData = { count: Array(7).fill(0), beneficiaries: Array(7).fill(0) };
                    
                    activities.forEach(a => {
                        const date = new Date(a.date.replace(/\//g, '-'));
                        const day = date.getDay();
                        weekdayData.count[day]++;
                        weekdayData.beneficiaries[day] += a.beneficiaries;
                    });
                    
                    options = {
                        series: [
                            { name: 'عدد المناشط', data: weekdayData.count },
                            { name: 'المستفيدين', data: weekdayData.beneficiaries }
                        ],
                        chart: { ...baseChartConfig, type: 'bar', height: 260 },
                        colors: ['#2D6A4F', '#FF8B8B'],
                        plotOptions: { bar: { borderRadius: 6, columnWidth: '55%' } },
                        xaxis: { categories: weekdays, labels: { style: { colors: colors.text, fontSize: '10px', fontWeight: 500 } }, axisBorder: { show: false }, axisTicks: { show: false } },
                        yaxis: [
                            { title: { text: 'المناشط', style: { color: colors.text, fontSize: '10px' } }, labels: { style: { colors: colors.text } } },
                            { opposite: true, title: { text: 'المستفيدين', style: { color: colors.text, fontSize: '10px' } }, labels: { style: { colors: colors.text } } }
                        ],
                        grid: { borderColor: colors.grid, strokeDashArray: 0 },
                        legend: { position: 'top', fontSize: '10px', fontWeight: 600, labels: { colors: isDarkMode() ? '#ccc' : '#555' }, markers: { radius: 3 } },
                        tooltip: { theme: isDarkMode() ? 'dark' : 'light' }
                    };
                    break;
                    
                case 'cumulativeGrowth':
                    const sortedAct = [...activities].sort((a, b) => new Date(a.date) - new Date(b.date));
                    let cumulative = 0;
                    const cumulativeData = sortedAct.map(a => {
                        cumulative += a.beneficiaries;
                        return { x: a.date.split('/').slice(1).join('/'), y: cumulative };
                    });
                    
                    options = {
                        series: [{ name: 'النمو التراكمي', data: cumulativeData }],
                        chart: { ...baseChartConfig, type: 'area', height: 260 },
                        colors: ['#2D6A4F'],
                        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.05, stops: [0, 90, 100] } },
                        stroke: { curve: 'smooth', width: 3 },
                        dataLabels: { enabled: false },
                        xaxis: { type: 'category', labels: { style: { colors: colors.text, fontSize: '9px' }, rotate: -45 }, axisBorder: { show: false }, axisTicks: { show: false } },
                        yaxis: { labels: { style: { colors: colors.text, fontSize: '10px' }, formatter: val => val.toLocaleString('ar-SA') } },
                        grid: { borderColor: colors.grid, strokeDashArray: 0 },
                        tooltip: { theme: isDarkMode() ? 'dark' : 'light', y: { formatter: val => val.toLocaleString('ar-SA') + ' مستفيد (تراكمي)' } }
                    };
                    break;
            }

            if (advancedChart) advancedChart.destroy();
            advancedChart = new ApexCharts(document.getElementById('advancedChart'), options);
            advancedChart.render();
        }

        // ========== جلب البيانات ==========
        async function loadData() {
            const indicator = document.getElementById('refresh-indicator');
            const refreshBtn = document.getElementById('refresh-btn');
            indicator.classList.remove('hidden');
            refreshBtn.classList.add('animate-spin');
            
            try {
                const response = await fetch(DATA_ENDPOINT);
                if (!response.ok) throw new Error('فشل');
                
                const data = await response.json();
                const raw = Array.isArray(data) ? data : (data.data || []);
                
                activities = raw.map(item => ({
                    date: item.executionDate || '',
                    beneficiaries: item.beneficiariesCount || 0,
                    classification: item.classification || '',
                    audience: Array.isArray(item.targetAudience) ? item.targetAudience.join(', ') : (item.targetAudience || ''),
                    type: item.programType || 'حضوري',
                    executor: item.executorName || '',
                    category: item.programCategory || ''
                }));
                
                updateAllCharts();
                
            } catch (error) {
                console.error('خطأ:', error);
                document.getElementById('kpi-beneficiaries').textContent = '!';
                document.getElementById('kpi-activities').textContent = '!';
                document.getElementById('kpi-executors').textContent = '!';
                document.getElementById('kpi-avg').textContent = '!';
            } finally {
                indicator.classList.add('hidden');
                refreshBtn.classList.remove('animate-spin');
            }
        }
        
        function updateAllCharts() {
            if (activities.length === 0) return;
            updateKPIs();
            createPieChart();
            updateLineChart();
            updateBarChart();
            updateAdvancedChart();
        }

        function startAutoRefresh() {
            setInterval(loadData, REFRESH_INTERVAL);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            startAutoRefresh();
        });
    </script>

</body>
</html>
