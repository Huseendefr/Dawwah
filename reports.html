<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تقارير المناشط</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700&family=Material+Icons+Round" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3D7A5A',
                        'primary-light': '#BDD5C4',
                        accent: '#FF8B8B',
                        'background-light': '#F4F4F4',
                        'background-dark': '#1A1A1A',
                        'card-light': '#FFFFFF',
                        'card-dark': '#2A2A2A',
                    },
                    fontFamily: {
                        sans: ['Noto Sans Arabic', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    
    <style>
        body { font-family: 'Noto Sans Arabic', sans-serif; }
        ::-webkit-scrollbar { width: 0; background: transparent; }
        .ios-blur { backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        select { background-image: none; }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen pb-24">

    <!-- ==================== الإعدادات والبيانات ==================== -->
    <script>
        // رابط جلب البيانات من n8n
        const DATA_ENDPOINT = 'https://n8n.smoo1.com/webhook/manashet-data';
        
        // فترة التحديث التلقائي (30 ثانية)
        const REFRESH_INTERVAL = 30000;
        
        // البيانات (ستُملأ من n8n)
        let activities = [];
        
        // اختصارات التصنيفات
        const shortNames = {
            'الشريعة والفقه والعبادات': 'الشريعة',
            'التوحيد والعقيدة': 'التوحيد',
            'الأخلاق والسلوك والأداب': 'الأخلاق',
            'الأمن الفكري والفكر المعتدل': 'الأمن الفكري'
        };
        
        // ألوان التصنيفات - محدثة بالهوية الجديدة
        const classColors = {
            'الشريعة والفقه والعبادات': '#3D7A5A',
            'التوحيد والعقيدة': '#FF8B8B',
            'الأخلاق والسلوك والأداب': '#64748B',
            'الأمن الفكري والفكر المعتدل': '#F59E0B'
        };
    </script>

    <!-- ==================== الهيدر ==================== -->
    <header class="px-5 pt-14 pb-4 sticky top-0 z-30 bg-background-light/80 dark:bg-background-dark/80 ios-blur">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-primary dark:text-primary-light">التقارير</h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">تحليل شامل لبيانات المناشط</p>
            </div>
            <div class="flex items-center gap-2">
                <!-- مؤشر التحديث -->
                <div id="refresh-indicator" class="hidden">
                    <span class="material-icons-round text-primary animate-spin">sync</span>
                </div>
                <button onclick="toggleDarkMode()" class="w-10 h-10 rounded-full bg-card-light dark:bg-card-dark shadow flex items-center justify-center border border-primary-light dark:border-slate-700">
                    <span class="material-icons-round text-slate-600 dark:text-slate-300">dark_mode</span>
                </button>
            </div>
        </div>
    </header>

    <!-- ==================== المحتوى الرئيسي ==================== -->
    <main class="px-5 space-y-6">
        
        <!-- ========== KPI Cards ========== -->
        <div class="grid grid-cols-3 gap-3">
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/30 dark:border-slate-700 text-center">
                <span class="material-icons-round text-primary dark:text-primary-light text-2xl mb-1 block">groups</span>
                <span id="kpi-beneficiaries" class="text-primary dark:text-primary-light font-bold text-xl block">0</span>
                <span class="text-[10px] text-slate-500 dark:text-slate-400">إجمالي المستفيدين</span>
            </div>
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/30 dark:border-slate-700 text-center">
                <span class="material-icons-round text-primary dark:text-primary-light text-2xl mb-1 block">event</span>
                <span id="kpi-activities" class="text-primary dark:text-primary-light font-bold text-xl block">0</span>
                <span class="text-[10px] text-slate-500 dark:text-slate-400">عدد المناشط</span>
            </div>
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/30 dark:border-slate-700 text-center">
                <span class="material-icons-round text-primary dark:text-primary-light text-2xl mb-1 block">person</span>
                <span id="kpi-executors" class="text-primary dark:text-primary-light font-bold text-xl block">0</span>
                <span class="text-[10px] text-slate-500 dark:text-slate-400">عدد المنفذين</span>
            </div>
        </div>

        <!-- ========== المخطط الدائري - التصنيفات (ثابت) ========== -->
        <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/30 dark:border-slate-700">
            <h3 class="font-semibold text-sm mb-4 flex items-center gap-2">
                <span class="material-icons-round text-primary text-lg">pie_chart</span>
                توزيع التصنيفات
                <span class="text-xs text-slate-400 font-normal">(نسبة كل تصنيف من المجموع)</span>
            </h3>
            <div id="pieChart"></div>
        </div>

        <!-- ========== مخطط الخط - مع فلتر ========== -->
        <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/30 dark:border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-sm flex items-center gap-2">
                    <span class="material-icons-round text-primary text-lg">trending_up</span>
                    تحليل الحضور
                </h3>
                <select id="lineChartFilter" onchange="updateLineChart()" class="text-xs bg-primary-light/20 dark:bg-slate-800 rounded-lg px-3 py-2 border border-primary-light/30 dark:border-slate-700 focus:ring-2 focus:ring-primary">
                    <option value="byDate">حسب التاريخ</option>
                    <option value="byClassification">حسب التصنيف</option>
                    <option value="byCategory">حسب فئة البرنامج</option>
                    <option value="byType">حضوري vs عن بعد</option>
                </select>
            </div>
            <div id="lineChart"></div>
        </div>

        <!-- ========== مخطط الأعمدة - مع فلتر ========== -->
        <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/30 dark:border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-sm flex items-center gap-2">
                    <span class="material-icons-round text-primary text-lg">bar_chart</span>
                    مقارنات
                </h3>
                <select id="barChartFilter" onchange="updateBarChart()" class="text-xs bg-primary-light/20 dark:bg-slate-800 rounded-lg px-3 py-2 border border-primary-light/30 dark:border-slate-700 focus:ring-2 focus:ring-primary">
                    <option value="topExecutors">أكثر المنفذين نشاطاً</option>
                    <option value="executorsBeneficiaries">المنفذين حسب المستفيدين</option>
                    <option value="audienceComparison">مقارنة الفئات المستهدفة</option>
                    <option value="categoryComparison">مقارنة فئات البرامج</option>
                </select>
            </div>
            <div id="barChart"></div>
        </div>

        <!-- ========== مخطط إضافي - المقارنة الزمنية ========== -->
        <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/30 dark:border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-sm flex items-center gap-2">
                    <span class="material-icons-round text-primary text-lg">compare_arrows</span>
                    مقارنة متقدمة
                </h3>
                <select id="advancedFilter" onchange="updateAdvancedChart()" class="text-xs bg-primary-light/20 dark:bg-slate-800 rounded-lg px-3 py-2 border border-primary-light/30 dark:border-slate-700 focus:ring-2 focus:ring-primary">
                    <option value="classificationTrend">اتجاه التصنيفات عبر الوقت</option>
                    <option value="weekdayAnalysis">تحليل أيام الأسبوع</option>
                    <option value="cumulativeGrowth">النمو التراكمي</option>
                </select>
            </div>
            <div id="advancedChart"></div>
        </div>

    </main>

    <!-- ==================== شريط التنقل ==================== -->
    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-card-light/90 dark:bg-card-dark/90 ios-blur border-t border-primary-light/30 dark:border-slate-800 flex justify-around items-center px-6 pb-4 z-40">
        <a href="manashet-dashboard.html" class="flex flex-col items-center text-slate-400 dark:text-slate-500">
            <span class="material-icons-round">dashboard</span>
            <span class="text-[10px] font-medium mt-1">الرئيسية</span>
        </a>
        <a href="#" class="flex flex-col items-center text-slate-400 dark:text-slate-500">
            <span class="material-icons-round">event_note</span>
            <span class="text-[10px] font-medium mt-1">البرامج</span>
        </a>
        <a href="reports.html" class="flex flex-col items-center text-primary">
            <span class="material-icons-round">analytics</span>
            <span class="text-[10px] font-medium mt-1">التقارير</span>
        </a>
        <a href="#" class="flex flex-col items-center text-slate-400 dark:text-slate-500">
            <span class="material-icons-round">settings</span>
            <span class="text-[10px] font-medium mt-1">الإعدادات</span>
        </a>
    </nav>

    <!-- ==================== JavaScript ==================== -->
    <script>
        // ========== المتغيرات العامة ==========
        let pieChart = null;
        let lineChart = null;
        let barChart = null;
        let advancedChart = null;

        // ========== الوضع الداكن ==========
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            setTimeout(updateAllCharts, 100);
        }

        function isDarkMode() {
            return document.documentElement.classList.contains('dark');
        }

        function getChartColors() {
            return isDarkMode() 
                ? { text: '#94a3b8', grid: '#334155', bg: 'transparent' }
                : { text: '#64748b', grid: '#e2e8f0', bg: 'transparent' };
        }

        // ========== حساب KPIs ==========
        function updateKPIs() {
            if (activities.length === 0) return;
            
            const total = activities.reduce((sum, a) => sum + a.beneficiaries, 0);
            const count = activities.length;
            const executors = [...new Set(activities.map(a => a.executor))].length;
            
            document.getElementById('kpi-beneficiaries').textContent = total.toLocaleString('ar-SA');
            document.getElementById('kpi-activities').textContent = count.toLocaleString('ar-SA');
            document.getElementById('kpi-executors').textContent = executors.toLocaleString('ar-SA');
        }

        // ========== المخطط الدائري (ثابت) ==========
        function createPieChart() {
            if (activities.length === 0) return;
            
            const colors = getChartColors();
            
            const classData = {};
            activities.forEach(a => {
                classData[a.classification] = (classData[a.classification] || 0) + a.beneficiaries;
            });
            
            const labels = Object.keys(classData).map(c => shortNames[c] || c);
            const series = Object.values(classData);
            const chartColors = Object.keys(classData).map(c => classColors[c] || '#3D7A5A');
            
            const options = {
                series: series,
                chart: {
                    type: 'donut',
                    height: 280,
                    fontFamily: 'Noto Sans Arabic, sans-serif',
                    background: colors.bg
                },
                labels: labels,
                colors: chartColors,
                plotOptions: {
                    pie: {
                        donut: {
                            size: '55%',
                            labels: {
                                show: true,
                                name: { show: true, fontSize: '14px', color: colors.text },
                                value: { 
                                    show: true, 
                                    fontSize: '18px', 
                                    fontWeight: 'bold',
                                    formatter: val => val + ' مستفيد'
                                },
                                total: {
                                    show: true,
                                    label: 'الإجمالي',
                                    fontSize: '12px',
                                    color: colors.text,
                                    formatter: w => w.globals.seriesTotals.reduce((a, b) => a + b, 0) + ' مستفيد'
                                }
                            }
                        }
                    }
                },
                legend: {
                    position: 'bottom',
                    fontSize: '11px',
                    labels: { colors: colors.text }
                },
                dataLabels: {
                    enabled: true,
                    formatter: (val) => val.toFixed(1) + '%',
                    style: { fontSize: '11px' }
                },
                tooltip: { y: { formatter: val => val + ' مستفيد' } }
            };

            if (pieChart) pieChart.destroy();
            pieChart = new ApexCharts(document.getElementById('pieChart'), options);
            pieChart.render();
        }

        // ========== مخطط الخط (مع فلتر) ==========
        function updateLineChart() {
            if (activities.length === 0) return;
            
            const filter = document.getElementById('lineChartFilter').value;
            const colors = getChartColors();
            let chartData = {};
            let chartType = 'area';
            
            switch(filter) {
                case 'byDate':
                    activities.forEach(a => {
                        const shortDate = a.date.split('/').slice(1).join('/');
                        chartData[shortDate] = (chartData[shortDate] || 0) + a.beneficiaries;
                    });
                    break;
                case 'byClassification':
                    activities.forEach(a => {
                        const name = shortNames[a.classification] || a.classification;
                        chartData[name] = (chartData[name] || 0) + a.beneficiaries;
                    });
                    chartType = 'bar';
                    break;
                case 'byCategory':
                    activities.forEach(a => {
                        chartData[a.category] = (chartData[a.category] || 0) + a.beneficiaries;
                    });
                    chartType = 'bar';
                    break;
                case 'byType':
                    activities.forEach(a => {
                        chartData[a.type] = (chartData[a.type] || 0) + a.beneficiaries;
                    });
                    chartType = 'bar';
                    break;
            }
            
            const categories = Object.keys(chartData);
            const series = Object.values(chartData);
            
            const options = {
                series: [{ name: 'المستفيدين', data: series }],
                chart: {
                    type: chartType,
                    height: 220,
                    fontFamily: 'Noto Sans Arabic, sans-serif',
                    toolbar: { show: false },
                    background: colors.bg
                },
                colors: ['#3D7A5A'],
                fill: chartType === 'area' ? {
                    type: 'gradient',
                    gradient: { shadeIntensity: 1, opacityFrom: 0.4, opacityTo: 0.1 }
                } : { opacity: 1 },
                stroke: { curve: 'smooth', width: chartType === 'area' ? 3 : 0 },
                plotOptions: chartType === 'bar' ? { bar: { borderRadius: 6, columnWidth: '60%' } } : {},
                dataLabels: { enabled: chartType === 'bar', style: { fontSize: '10px' } },
                xaxis: {
                    categories: categories,
                    labels: { style: { colors: colors.text, fontSize: '10px' }, rotate: -45 },
                    axisBorder: { show: false }
                },
                yaxis: { labels: { style: { colors: colors.text, fontSize: '10px' } } },
                grid: { borderColor: colors.grid, strokeDashArray: 4 },
                tooltip: { theme: isDarkMode() ? 'dark' : 'light', y: { formatter: val => val + ' مستفيد' } }
            };

            if (lineChart) lineChart.destroy();
            lineChart = new ApexCharts(document.getElementById('lineChart'), options);
            lineChart.render();
        }

        // ========== مخطط الأعمدة (مع فلتر) ==========
        function updateBarChart() {
            if (activities.length === 0) return;
            
            const filter = document.getElementById('barChartFilter').value;
            const colors = getChartColors();
            let chartData = {};
            
            switch(filter) {
                case 'topExecutors':
                    activities.forEach(a => { chartData[a.executor] = (chartData[a.executor] || 0) + 1; });
                    break;
                case 'executorsBeneficiaries':
                    activities.forEach(a => { chartData[a.executor] = (chartData[a.executor] || 0) + a.beneficiaries; });
                    break;
                case 'audienceComparison':
                    activities.forEach(a => {
                        a.audience.split(',').map(s => s.trim()).forEach(aud => {
                            chartData[aud] = (chartData[aud] || 0) + a.beneficiaries;
                        });
                    });
                    break;
                case 'categoryComparison':
                    activities.forEach(a => { chartData[a.category] = (chartData[a.category] || 0) + a.beneficiaries; });
                    break;
            }
            
            let sorted = Object.entries(chartData).sort((a, b) => b[1] - a[1]);
            if (filter === 'topExecutors' || filter === 'executorsBeneficiaries') sorted = sorted.slice(0, 8);
            
            const categories = sorted.map(([k]) => k.length > 18 ? k.substring(0, 18) + '...' : k);
            const series = sorted.map(([, v]) => v);
            
            const options = {
                series: [{ name: filter.includes('Beneficiaries') || filter.includes('Comparison') ? 'المستفيدين' : 'المناشط', data: series }],
                chart: {
                    type: 'bar',
                    height: 280,
                    fontFamily: 'Noto Sans Arabic, sans-serif',
                    toolbar: { show: false },
                    background: colors.bg
                },
                colors: ['#3D7A5A', '#5A9A77', '#7AB894', '#9AD4B1', '#BDD5C4', '#D4E8DC', '#E8F4ED', '#F4FAF6'],
                plotOptions: { bar: { borderRadius: 6, horizontal: true, distributed: true, barHeight: '70%' } },
                dataLabels: {
                    enabled: true,
                    textAnchor: 'start',
                    formatter: val => val.toLocaleString('ar-SA'),
                    style: { colors: ['#fff'], fontSize: '11px' },
                    offsetX: 5
                },
                xaxis: { categories: categories, labels: { style: { colors: colors.text, fontSize: '10px' } } },
                yaxis: { labels: { style: { colors: colors.text, fontSize: '10px' } } },
                grid: { borderColor: colors.grid, strokeDashArray: 4, xaxis: { lines: { show: true } }, yaxis: { lines: { show: false } } },
                legend: { show: false },
                tooltip: { theme: isDarkMode() ? 'dark' : 'light' }
            };

            if (barChart) barChart.destroy();
            barChart = new ApexCharts(document.getElementById('barChart'), options);
            barChart.render();
        }

        // ========== المخطط المتقدم (مع فلتر) ==========
        function updateAdvancedChart() {
            if (activities.length === 0) return;
            
            const filter = document.getElementById('advancedFilter').value;
            const colors = getChartColors();
            let options = {};
            
            switch(filter) {
                case 'classificationTrend':
                    const dateClassData = {};
                    const allDates = [...new Set(activities.map(a => a.date))].sort();
                    const allClasses = [...new Set(activities.map(a => a.classification))];
                    
                    allClasses.forEach(cls => {
                        dateClassData[cls] = allDates.map(date => 
                            activities.filter(a => a.date === date && a.classification === cls)
                                .reduce((sum, a) => sum + a.beneficiaries, 0)
                        );
                    });
                    
                    options = {
                        series: allClasses.map(cls => ({ name: shortNames[cls] || cls, data: dateClassData[cls] })),
                        chart: { type: 'line', height: 250, fontFamily: 'Noto Sans Arabic', toolbar: { show: false }, background: colors.bg },
                        colors: Object.values(classColors),
                        stroke: { curve: 'smooth', width: 2 },
                        xaxis: { categories: allDates.map(d => d.split('/').slice(1).join('/')), labels: { style: { colors: colors.text, fontSize: '9px' }, rotate: -45 } },
                        yaxis: { labels: { style: { colors: colors.text, fontSize: '10px' } } },
                        grid: { borderColor: colors.grid, strokeDashArray: 4 },
                        legend: { position: 'top', fontSize: '10px', labels: { colors: colors.text } },
                        tooltip: { theme: isDarkMode() ? 'dark' : 'light' }
                    };
                    break;
                    
                case 'weekdayAnalysis':
                    const weekdays = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                    const weekdayData = { count: Array(7).fill(0), beneficiaries: Array(7).fill(0) };
                    
                    activities.forEach(a => {
                        const date = new Date(a.date.replace(/\//g, '-'));
                        const day = date.getDay();
                        weekdayData.count[day]++;
                        weekdayData.beneficiaries[day] += a.beneficiaries;
                    });
                    
                    options = {
                        series: [
                            { name: 'عدد المناشط', data: weekdayData.count },
                            { name: 'المستفيدين', data: weekdayData.beneficiaries }
                        ],
                        chart: { type: 'bar', height: 250, fontFamily: 'Noto Sans Arabic', toolbar: { show: false }, background: colors.bg },
                        colors: ['#3D7A5A', '#FF8B8B'],
                        plotOptions: { bar: { borderRadius: 4, columnWidth: '60%' } },
                        xaxis: { categories: weekdays, labels: { style: { colors: colors.text, fontSize: '10px' } } },
                        yaxis: [
                            { title: { text: 'المناشط', style: { color: colors.text, fontSize: '10px' } }, labels: { style: { colors: colors.text } } },
                            { opposite: true, title: { text: 'المستفيدين', style: { color: colors.text, fontSize: '10px' } }, labels: { style: { colors: colors.text } } }
                        ],
                        grid: { borderColor: colors.grid, strokeDashArray: 4 },
                        legend: { position: 'top', fontSize: '10px', labels: { colors: colors.text } },
                        tooltip: { theme: isDarkMode() ? 'dark' : 'light' }
                    };
                    break;
                    
                case 'cumulativeGrowth':
                    const sortedAct = [...activities].sort((a, b) => new Date(a.date) - new Date(b.date));
                    let cumulative = 0;
                    const cumulativeData = sortedAct.map(a => {
                        cumulative += a.beneficiaries;
                        return { x: a.date.split('/').slice(1).join('/'), y: cumulative };
                    });
                    
                    options = {
                        series: [{ name: 'النمو التراكمي', data: cumulativeData }],
                        chart: { type: 'area', height: 250, fontFamily: 'Noto Sans Arabic', toolbar: { show: false }, background: colors.bg },
                        colors: ['#3D7A5A'],
                        fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.5, opacityTo: 0.1 } },
                        stroke: { curve: 'smooth', width: 3 },
                        dataLabels: { enabled: false },
                        xaxis: { type: 'category', labels: { style: { colors: colors.text, fontSize: '9px' }, rotate: -45 } },
                        yaxis: { labels: { style: { colors: colors.text, fontSize: '10px' }, formatter: val => val.toLocaleString('ar-SA') } },
                        grid: { borderColor: colors.grid, strokeDashArray: 4 },
                        tooltip: { theme: isDarkMode() ? 'dark' : 'light', y: { formatter: val => val + ' مستفيد (تراكمي)' } }
                    };
                    break;
            }

            if (advancedChart) advancedChart.destroy();
            advancedChart = new ApexCharts(document.getElementById('advancedChart'), options);
            advancedChart.render();
        }

        // ========== جلب البيانات من n8n ==========
        async function loadData() {
            // إظهار مؤشر التحديث
            const indicator = document.getElementById('refresh-indicator');
            indicator.classList.remove('hidden');
            
            try {
                const response = await fetch(DATA_ENDPOINT);
                if (!response.ok) throw new Error('فشل في جلب البيانات');
                
                const data = await response.json();
                
                // تحويل البيانات للصيغة المطلوبة
                if (Array.isArray(data)) {
                    activities = data.map(item => ({
                        date: item.executionDate || '',
                        beneficiaries: item.beneficiariesCount || 0,
                        classification: item.classification || '',
                        audience: Array.isArray(item.targetAudience) ? item.targetAudience.join(', ') : (item.targetAudience || ''),
                        type: item.programType || 'حضوري',
                        executor: item.executorName || '',
                        category: item.programCategory || ''
                    }));
                } else if (data.data && Array.isArray(data.data)) {
                    activities = data.data.map(item => ({
                        date: item.executionDate || '',
                        beneficiaries: item.beneficiariesCount || 0,
                        classification: item.classification || '',
                        audience: Array.isArray(item.targetAudience) ? item.targetAudience.join(', ') : (item.targetAudience || ''),
                        type: item.programType || 'حضوري',
                        executor: item.executorName || '',
                        category: item.programCategory || ''
                    }));
                }
                
                // تحديث جميع المخططات
                updateAllCharts();
                
            } catch (error) {
                console.error('خطأ في جلب البيانات:', error);
                // عرض رسالة خطأ للمستخدم
                document.getElementById('kpi-beneficiaries').textContent = '!';
                document.getElementById('kpi-activities').textContent = '!';
                document.getElementById('kpi-executors').textContent = '!';
            } finally {
                // إخفاء مؤشر التحديث
                indicator.classList.add('hidden');
            }
        }
        
        // ========== تحديث جميع المخططات ==========
        function updateAllCharts() {
            if (activities.length === 0) return;
            
            updateKPIs();
            createPieChart();
            updateLineChart();
            updateBarChart();
            updateAdvancedChart();
        }

        // ========== التحديث التلقائي ==========
        function startAutoRefresh() {
            setInterval(loadData, REFRESH_INTERVAL);
        }

        // ========== التهيئة ==========
        function init() {
            loadData();
            startAutoRefresh();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>

</body>
</html>
