<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>لوحة إحصائيات البرامج</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700&family=Material+Icons+Round" rel="stylesheet"/>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#3D7A5A",
                        "primary-light": "#BDD5C4",
                        accent: "#FF8B8B",
                        "background-light": "#F4F4F4",
                        "background-dark": "#1A1A1A",
                        "card-light": "#FFFFFF",
                        "card-dark": "#2A2A2A",
                    },
                    fontFamily: {
                        display: ["Noto Sans Arabic", "sans-serif"],
                        sans: ["Noto Sans Arabic", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "16px",
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Noto Sans Arabic', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
        .ios-blur {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        body {
            min-height: max(884px, 100dvh);
        }
        .skeleton {
            background: linear-gradient(90deg, #e8e8e8 25%, #d8d8d8 50%, #e8e8e8 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        .dark .skeleton {
            background: linear-gradient(90deg, #333 25%, #444 50%, #333 75%);
            background-size: 200% 100%;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .filter-chip {
            transition: all 0.2s ease;
        }
        .filter-chip.active {
            background-color: #3D7A5A;
            color: white;
        }
        .ai-modal {
            transition: all 0.3s ease;
        }
        .ai-messages {
            max-height: 60vh;
            overflow-y: auto;
        }
        .typing-indicator span {
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
        /* Gradient backgrounds */
        .gradient-card {
            background: linear-gradient(135deg, #BDD5C4 0%, #ffffff 100%);
        }
        .dark .gradient-card {
            background: linear-gradient(135deg, #2A3A30 0%, #2A2A2A 100%);
        }
        .accent-gradient {
            background: linear-gradient(135deg, #FF8B8B 0%, #FFB4B4 100%);
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen">
    <div class="h-12 w-full"></div>
    
    <header class="px-5 pb-4 sticky top-0 z-30 bg-background-light/80 dark:bg-background-dark/80 ios-blur">
        <div class="flex justify-between items-center mb-6 pt-2">
            <div>
                <h1 class="text-2xl font-bold text-primary dark:text-primary-light">الإحصائيات العامة</h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">نظرة شاملة على البرامج والفعاليات</p>
            </div>
            <div class="flex items-center gap-2">
                <!-- مؤشر التحديث -->
                <div id="refresh-indicator" class="hidden">
                    <span class="material-icons-round text-primary animate-spin text-xl">sync</span>
                </div>
                <div class="w-10 h-10 rounded-full bg-primary-light dark:bg-slate-700 flex items-center justify-center overflow-hidden">
                    <span class="material-icons-round text-primary dark:text-primary-light">account_circle</span>
                </div>
            </div>
        </div>
        
        <!-- الإحصائيات العامة -->
        <div class="grid grid-cols-3 gap-3 mb-6">
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/30 dark:border-slate-700 text-center">
                <span id="total-beneficiaries" class="text-primary dark:text-primary-light font-bold text-xl block">--</span>
                <span class="text-[10px] text-slate-500 dark:text-slate-400 uppercase tracking-wide">إجمالي المستفيدين</span>
            </div>
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/30 dark:border-slate-700 text-center">
                <span id="total-programs" class="text-primary dark:text-primary-light font-bold text-xl block">--</span>
                <span class="text-[10px] text-slate-500 dark:text-slate-400 uppercase tracking-wide">عدد البرامج</span>
            </div>
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/30 dark:border-slate-700 text-center">
                <span id="avg-attendance" class="text-primary dark:text-primary-light font-bold text-xl block">--</span>
                <span class="text-[10px] text-slate-500 dark:text-slate-400 uppercase tracking-wide">متوسط الحضور</span>
            </div>
        </div>
        
        <!-- البحث والفلترة -->
        <div class="flex gap-2 mb-4">
            <div class="relative flex-1">
                <span class="material-icons-round absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xl">search</span>
                <input id="search-input" class="w-full pr-10 pl-4 py-3 bg-card-light dark:bg-card-dark border border-primary-light/20 dark:border-slate-700 rounded-xl text-sm focus:ring-2 focus:ring-primary shadow-sm dark:text-white" placeholder="البحث عن برنامج أو منفذ..." type="text"/>
            </div>
            <button id="filter-btn" class="w-12 h-12 bg-primary text-white rounded-xl flex items-center justify-center shadow-lg shadow-primary/20">
                <span class="material-icons-round">tune</span>
            </button>
        </div>
        
        <!-- شرائح الفلترة -->
        <div id="filter-chips" class="flex gap-2 overflow-x-auto pb-2 hidden">
            <button class="filter-chip active px-4 py-2 bg-primary-light/50 dark:bg-slate-800 rounded-full text-xs font-medium whitespace-nowrap" data-filter="all">الكل</button>
            <button class="filter-chip px-4 py-2 bg-primary-light/50 dark:bg-slate-800 rounded-full text-xs font-medium whitespace-nowrap" data-filter="الشريعة والفقه والعبادات">الشريعة والفقه</button>
            <button class="filter-chip px-4 py-2 bg-primary-light/50 dark:bg-slate-800 rounded-full text-xs font-medium whitespace-nowrap" data-filter="التوحيد والعقيدة">التوحيد والعقيدة</button>
            <button class="filter-chip px-4 py-2 bg-primary-light/50 dark:bg-slate-800 rounded-full text-xs font-medium whitespace-nowrap" data-filter="الأخلاق والسلوك والأداب">الأخلاق والسلوك</button>
            <button class="filter-chip px-4 py-2 bg-primary-light/50 dark:bg-slate-800 rounded-full text-xs font-medium whitespace-nowrap" data-filter="الأمن الفكري والفكر المعتدل">الأمن الفكري</button>
        </div>
    </header>
    
    <main class="px-5 pb-24">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold">أحدث البرامج</h2>
            <span id="programs-count" class="text-primary dark:text-primary-light text-sm font-medium">-- برنامج</span>
        </div>
        
        <!-- قائمة البرامج -->
        <div id="programs-list" class="space-y-4">
            <!-- سيتم ملء هذا ديناميكياً -->
        </div>
        
        <!-- حالة التحميل -->
        <div id="loading-state" class="space-y-4">
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/20 dark:border-slate-700">
                <div class="skeleton h-6 w-24 rounded-full mb-3"></div>
                <div class="skeleton h-5 w-3/4 rounded mb-3"></div>
                <div class="skeleton h-4 w-1/2 rounded"></div>
            </div>
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/20 dark:border-slate-700">
                <div class="skeleton h-6 w-24 rounded-full mb-3"></div>
                <div class="skeleton h-5 w-3/4 rounded mb-3"></div>
                <div class="skeleton h-4 w-1/2 rounded"></div>
            </div>
            <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-primary-light/20 dark:border-slate-700">
                <div class="skeleton h-6 w-24 rounded-full mb-3"></div>
                <div class="skeleton h-5 w-3/4 rounded mb-3"></div>
                <div class="skeleton h-4 w-1/2 rounded"></div>
            </div>
        </div>
        
        <!-- حالة الخطأ -->
        <div id="error-state" class="hidden text-center py-12">
            <span class="material-icons-round text-6xl text-slate-300 dark:text-slate-600 mb-4 block">cloud_off</span>
            <p class="text-slate-500 dark:text-slate-400 mb-4">حدث خطأ في تحميل البيانات</p>
            <button onclick="loadData()" class="px-6 py-2 bg-primary text-white rounded-xl">إعادة المحاولة</button>
        </div>
        
        <!-- حالة فارغة -->
        <div id="empty-state" class="hidden text-center py-12">
            <span class="material-icons-round text-6xl text-slate-300 dark:text-slate-600 mb-4 block">search_off</span>
            <p class="text-slate-500 dark:text-slate-400">لا توجد نتائج مطابقة</p>
        </div>
    </main>
    
    <!-- زر المساعد الذكي - في الأعلى -->
    <button id="ai-btn" class="fixed top-4 right-4 h-10 px-4 bg-primary text-white rounded-xl shadow-lg shadow-primary/30 flex items-center justify-center z-50 transition-transform active:scale-95 gap-2">
        <span class="material-icons-round text-xl">auto_awesome</span>
        <span class="text-xs font-bold">المساعد الذكي</span>
    </button>
    
    <!-- نافذة المساعد الذكي -->
    <div id="ai-modal" class="ai-modal fixed inset-0 bg-black/50 z-[100] hidden items-end justify-center">
        <div class="bg-card-light dark:bg-card-dark w-full max-w-lg rounded-t-3xl p-5 max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary-light rounded-full flex items-center justify-center">
                        <span class="material-icons-round text-primary">auto_awesome</span>
                    </div>
                    <div>
                        <h3 class="font-bold">المساعد الذكي</h3>
                        <p class="text-xs text-slate-500">اسألني عن البيانات والإحصائيات</p>
                    </div>
                </div>
                <button id="close-ai" class="w-8 h-8 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center">
                    <span class="material-icons-round text-slate-500">close</span>
                </button>
            </div>
            
            <!-- الرسائل -->
            <div id="ai-messages" class="ai-messages flex-1 space-y-4 mb-4 overflow-y-auto">
                <div class="flex gap-3">
                    <div class="w-8 h-8 bg-primary-light rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="material-icons-round text-primary text-sm">auto_awesome</span>
                    </div>
                    <div class="bg-primary-light/30 dark:bg-slate-800 rounded-2xl rounded-tr-none p-3 max-w-[85%]">
                        <p class="text-sm">مرحباً! أنا المساعد الذكي للمناشط. يمكنني تحليل البيانات والإجابة عن استفساراتك. جرّب أن تسألني:</p>
                        <ul class="text-xs text-slate-600 dark:text-slate-400 mt-2 space-y-1">
                            <li>• كم إجمالي المستفيدين هذا الشهر؟</li>
                            <li>• من هو أكثر داعية نشاطاً؟</li>
                            <li>• ما هو التصنيف الأكثر تكراراً؟</li>
                            <li>• كم عدد مناشط الشيخ نايف الزهراني؟</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- حقل الإدخال -->
            <div class="flex gap-2">
                <input id="ai-input" type="text" placeholder="اكتب سؤالك هنا..." class="flex-1 px-4 py-3 bg-primary-light/20 dark:bg-slate-800 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary"/>
                <button id="ai-send" class="w-12 h-12 bg-primary text-white rounded-xl flex items-center justify-center">
                    <span class="material-icons-round">send</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- شريط التنقل -->
    <nav class="fixed bottom-0 left-0 right-0 h-20 bg-card-light/90 dark:bg-card-dark/90 ios-blur border-t border-primary-light/30 dark:border-slate-800 flex justify-around items-center px-6 pb-4 z-40">
        <a href="manashet-dashboard.html" class="flex flex-col items-center text-primary">
            <span class="material-icons-round">dashboard</span>
            <span class="text-[10px] font-medium mt-1">الرئيسية</span>
        </a>
        <a href="#" class="flex flex-col items-center text-slate-400 dark:text-slate-500">
            <span class="material-icons-round">event_note</span>
            <span class="text-[10px] font-medium mt-1">البرامج</span>
        </a>
        <a href="reports.html" class="flex flex-col items-center text-slate-400 dark:text-slate-500">
            <span class="material-icons-round">analytics</span>
            <span class="text-[10px] font-medium mt-1">التقارير</span>
        </a>
        <a href="#" class="flex flex-col items-center text-slate-400 dark:text-slate-500">
            <span class="material-icons-round">settings</span>
            <span class="text-[10px] font-medium mt-1">الإعدادات</span>
        </a>
    </nav>
    
    <!-- زر الوضع الداكن -->
    <button class="fixed top-4 left-4 w-10 h-10 rounded-full bg-white dark:bg-slate-800 shadow-md flex items-center justify-center z-50 border border-primary-light dark:border-slate-700" onclick="document.documentElement.classList.toggle('dark')">
        <span class="material-icons-round text-slate-700 dark:text-slate-200 text-xl">dark_mode</span>
    </button>

    <script>
        // ==================== الإعدادات ====================
        const CONFIG = {
            // روابط n8n webhooks
            DATA_ENDPOINT: 'https://n8n.smoo1.com/webhook/manashet-data',
            AI_ENDPOINT: 'https://n8n.smoo1.com/webhook/ai-assistant',
            
            // فترة التحديث التلقائي (بالمللي ثانية) - 30 ثانية
            REFRESH_INTERVAL: 30000,
            
            // ألوان التصنيفات - محدثة بالهوية الجديدة
            CLASSIFICATION_COLORS: {
                'الشريعة والفقه والعبادات': { bg: 'bg-[#BDD5C4]/30 dark:bg-[#3D7A5A]/30', text: 'text-[#3D7A5A] dark:text-[#BDD5C4]' },
                'التوحيد والعقيدة': { bg: 'bg-[#FF8B8B]/20 dark:bg-[#FF8B8B]/20', text: 'text-[#c45c5c] dark:text-[#FF8B8B]' },
                'الأخلاق والسلوك والأداب': { bg: 'bg-slate-100 dark:bg-slate-800', text: 'text-slate-700 dark:text-slate-300' },
                'الأمن الفكري والفكر المعتدل': { bg: 'bg-amber-50 dark:bg-amber-900/30', text: 'text-amber-700 dark:text-amber-300' },
                'default': { bg: 'bg-[#BDD5C4]/20 dark:bg-[#3D7A5A]/20', text: 'text-[#3D7A5A] dark:text-[#BDD5C4]' }
            }
        };

        // ==================== المتغيرات العامة ====================
        let allData = [];
        let filteredData = [];
        let currentFilter = 'all';
        let searchQuery = '';
        let refreshTimer = null;

        // ==================== عناصر DOM ====================
        const elements = {
            programsList: document.getElementById('programs-list'),
            loadingState: document.getElementById('loading-state'),
            errorState: document.getElementById('error-state'),
            emptyState: document.getElementById('empty-state'),
            totalBeneficiaries: document.getElementById('total-beneficiaries'),
            totalPrograms: document.getElementById('total-programs'),
            avgAttendance: document.getElementById('avg-attendance'),
            programsCount: document.getElementById('programs-count'),
            searchInput: document.getElementById('search-input'),
            filterBtn: document.getElementById('filter-btn'),
            filterChips: document.getElementById('filter-chips'),
            refreshIndicator: document.getElementById('refresh-indicator'),
            aiBtn: document.getElementById('ai-btn'),
            aiModal: document.getElementById('ai-modal'),
            closeAi: document.getElementById('close-ai'),
            aiMessages: document.getElementById('ai-messages'),
            aiInput: document.getElementById('ai-input'),
            aiSend: document.getElementById('ai-send')
        };

        // ==================== دوال جلب البيانات ====================
        async function loadData() {
            showLoading();
            
            try {
                const response = await fetch(CONFIG.DATA_ENDPOINT);
                
                if (!response.ok) {
                    throw new Error('فشل في جلب البيانات');
                }
                
                const data = await response.json();
                
                // التحقق من صيغة البيانات
                if (Array.isArray(data)) {
                    allData = data;
                } else if (data.data && Array.isArray(data.data)) {
                    allData = data.data;
                } else {
                    throw new Error('صيغة البيانات غير صحيحة');
                }
                
                // ترتيب البيانات حسب التاريخ (الأحدث أولاً)
                allData.sort((a, b) => {
                    const dateA = new Date(a.timestamp || a.executionDate || 0);
                    const dateB = new Date(b.timestamp || b.executionDate || 0);
                    return dateB - dateA;
                });
                
                applyFilters();
                updateStats();
                hideLoading();
                
            } catch (error) {
                console.error('خطأ في جلب البيانات:', error);
                showError();
            }
        }

        // ==================== دوال العرض ====================
        function showLoading() {
            elements.loadingState.classList.remove('hidden');
            elements.programsList.classList.add('hidden');
            elements.errorState.classList.add('hidden');
            elements.emptyState.classList.add('hidden');
        }

        function hideLoading() {
            elements.loadingState.classList.add('hidden');
            elements.programsList.classList.remove('hidden');
        }

        function showError() {
            elements.loadingState.classList.add('hidden');
            elements.programsList.classList.add('hidden');
            elements.errorState.classList.remove('hidden');
            elements.emptyState.classList.add('hidden');
        }

        function showEmpty() {
            elements.loadingState.classList.add('hidden');
            elements.programsList.classList.add('hidden');
            elements.errorState.classList.add('hidden');
            elements.emptyState.classList.remove('hidden');
        }

        // ==================== دوال الإحصائيات ====================
        function updateStats() {
            const totalBeneficiaries = allData.reduce((sum, item) => sum + (item.beneficiariesCount || 0), 0);
            const totalPrograms = allData.length;
            const avgAttendance = totalPrograms > 0 ? Math.round(totalBeneficiaries / totalPrograms) : 0;
            
            // تحديث العرض مع تأثير
            animateNumber(elements.totalBeneficiaries, totalBeneficiaries);
            animateNumber(elements.totalPrograms, totalPrograms);
            animateNumber(elements.avgAttendance, avgAttendance);
        }

        function animateNumber(element, target) {
            const duration = 500;
            const start = parseInt(element.textContent) || 0;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.round(start + (target - start) * progress);
                element.textContent = current.toLocaleString('ar-SA');
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        // ==================== دوال الفلترة والبحث ====================
        function applyFilters() {
            filteredData = allData.filter(item => {
                // فلترة حسب التصنيف
                const matchesFilter = currentFilter === 'all' || 
                    (item.classification && item.classification.includes(currentFilter));
                
                // فلترة حسب البحث
                const searchLower = searchQuery.toLowerCase();
                const matchesSearch = searchQuery === '' || 
                    (item.programName && item.programName.toLowerCase().includes(searchLower)) ||
                    (item.executorName && item.executorName.toLowerCase().includes(searchLower)) ||
                    (item.supervisorName && item.supervisorName.toLowerCase().includes(searchLower)) ||
                    (item.classification && item.classification.toLowerCase().includes(searchLower));
                
                return matchesFilter && matchesSearch;
            });
            
            renderPrograms();
            elements.programsCount.textContent = `${filteredData.length} برنامج`;
        }

        // ==================== دوال عرض البرامج ====================
        function renderPrograms() {
            if (filteredData.length === 0) {
                showEmpty();
                return;
            }
            
            elements.programsList.innerHTML = filteredData.map(item => createProgramCard(item)).join('');
            elements.programsList.classList.remove('hidden');
            elements.emptyState.classList.add('hidden');
        }

        function createProgramCard(item) {
            const colors = CONFIG.CLASSIFICATION_COLORS[item.classification] || CONFIG.CLASSIFICATION_COLORS.default;
            const isRemote = item.programType === 'عن بعد';
            const shortClassification = getShortClassification(item.classification);
            
            // تنسيق التاريخ
            const date = formatDate(item.executionDate);
            
            // الفئة المستهدفة
            const audience = Array.isArray(item.targetAudience) 
                ? item.targetAudience.join(', ') 
                : (item.targetAudience || 'غير محدد');
            
            return `
                <div class="bg-card-light dark:bg-card-dark p-4 rounded-2xl shadow-sm border border-[#BDD5C4]/30 dark:border-slate-700 transition-all active:scale-[0.98]">
                    <div class="flex justify-between items-start mb-3">
                        <span class="px-3 py-1 ${colors.bg} ${colors.text} rounded-full text-[10px] font-bold">${shortClassification}</span>
                        <div class="flex items-center gap-1 text-slate-400">
                            ${isRemote ? `
                                <span class="flex h-2 w-2 rounded-full bg-[#FF8B8B] animate-pulse"></span>
                                <span class="text-xs font-bold text-[#FF8B8B]">عن بعد</span>
                            ` : `
                                <span class="material-icons-round text-sm">groups</span>
                                <span class="text-xs font-semibold">${item.beneficiariesCount || 0} مستفيد</span>
                            `}
                        </div>
                    </div>
                    <h3 class="font-bold text-md mb-1 leading-tight">${item.programName || 'بدون عنوان'}</h3>
                    <div class="grid grid-cols-2 gap-2 mt-3 pt-3 border-t border-[#BDD5C4]/20 dark:border-slate-800">
                        <div class="flex items-center gap-2">
                            <span class="material-icons-round text-[#3D7A5A] dark:text-[#BDD5C4] text-sm">person</span>
                            <span class="text-xs text-slate-600 dark:text-slate-400">${item.executorName || 'غير محدد'}</span>
                        </div>
                        <div class="flex items-center gap-2 justify-end">
                            ${isRemote ? `
                                <span class="material-icons-round text-slate-400 text-sm">groups</span>
                                <span class="text-xs text-slate-600 dark:text-slate-400">${item.beneficiariesCount || 0} ${audience}</span>
                            ` : `
                                <span class="material-icons-round text-[#3D7A5A] dark:text-[#BDD5C4] text-sm">calendar_today</span>
                                <span class="text-xs text-slate-600 dark:text-slate-400">${date}</span>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        function getShortClassification(classification) {
            const map = {
                'الشريعة والفقه والعبادات': 'الشريعة والفقه',
                'التوحيد والعقيدة': 'التوحيد والعقيدة',
                'الأخلاق والسلوك والأداب': 'الأخلاق والسلوك',
                'الأمن الفكري والفكر المعتدل': 'الأمن الفكري'
            };
            return map[classification] || classification || 'محاضرات عامة';
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'غير محدد';
            
            try {
                // محاولة تحليل التاريخ
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    return `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
                return dateStr;
            } catch {
                return dateStr;
            }
        }

        // ==================== دوال المساعد الذكي ====================
        function openAiModal() {
            elements.aiModal.classList.remove('hidden');
            elements.aiModal.classList.add('flex');
            elements.aiInput.focus();
        }

        function closeAiModal() {
            elements.aiModal.classList.add('hidden');
            elements.aiModal.classList.remove('flex');
        }

        async function sendAiMessage() {
            const question = elements.aiInput.value.trim();
            if (!question) return;
            
            // إضافة رسالة المستخدم
            addUserMessage(question);
            elements.aiInput.value = '';
            
            // إظهار مؤشر الكتابة
            showTypingIndicator();
            
            try {
                // تجهيز سياق البيانات من قاعدة البيانات
                const context = prepareDataContext();
                
                // System Prompt بالعربية
                const systemPrompt = `أنت مساعد ذكي متخصص في تحليل بيانات المناشط والبرامج الدعوية.

## تعليمات صارمة:
1. أجب دائماً باللغة العربية الفصحى فقط
2. أجب فقط بناءً على البيانات المقدمة لك في السياق
3. إذا لم تجد معلومة، قل "هذه المعلومة غير متوفرة في البيانات الحالية"
4. لا تختلق أو تفترض معلومات غير موجودة
5. كن دقيقاً في الأرقام والإحصائيات
6. اجعل إجاباتك مختصرة ومباشرة
7. استخدم الأرقام العربية عند الإمكان

## تنسيق الإجابة:
- كن مختصراً ومفيداً
- استخدم النقاط عند سرد عدة عناصر
- أضف الأرقام والنسب المئوية عند الإمكان`;
                
                const response = await fetch(CONFIG.AI_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userQuestion: question,
                        context: context,
                        systemPrompt: systemPrompt
                    })
                });
                
                const data = await response.json();
                
                removeTypingIndicator();
                
                if (data.response) {
                    addAiMessage(data.response);
                } else {
                    addAiMessage('عذراً، لم أتمكن من معالجة طلبك. يرجى المحاولة مرة أخرى.');
                }
                
            } catch (error) {
                console.error('خطأ في المساعد الذكي:', error);
                removeTypingIndicator();
                addAiMessage('عذراً، حدث خطأ في الاتصال. يرجى المحاولة مرة أخرى.');
            }
        }

        function prepareDataContext() {
            // التحقق من وجود بيانات
            if (!allData || allData.length === 0) {
                return 'لا توجد بيانات متاحة حالياً. يرجى التأكد من اتصال قاعدة البيانات.';
            }
            
            // تجهيز ملخص شامل للبيانات من قاعدة البيانات
            const summary = {
                totalPrograms: allData.length,
                totalBeneficiaries: allData.reduce((sum, item) => sum + (item.beneficiariesCount || 0), 0),
                classifications: {},
                executors: {},
                supervisors: {},
                months: {},
                programTypes: { 'حضوري': 0, 'عن بعد': 0 },
                programCategories: {},
                targetAudiences: {}
            };
            
            allData.forEach(item => {
                // التصنيفات
                const cls = item.classification || 'غير محدد';
                if (!summary.classifications[cls]) {
                    summary.classifications[cls] = { count: 0, beneficiaries: 0 };
                }
                summary.classifications[cls].count++;
                summary.classifications[cls].beneficiaries += item.beneficiariesCount || 0;
                
                // المنفذون (الدعاة)
                const exec = item.executorName || 'غير محدد';
                if (!summary.executors[exec]) {
                    summary.executors[exec] = { count: 0, beneficiaries: 0, programs: [] };
                }
                summary.executors[exec].count++;
                summary.executors[exec].beneficiaries += item.beneficiariesCount || 0;
                summary.executors[exec].programs.push(item.programName);
                
                // المشرفون
                const sup = item.supervisorName || 'غير محدد';
                if (!summary.supervisors[sup]) {
                    summary.supervisors[sup] = { count: 0 };
                }
                summary.supervisors[sup].count++;
                
                // فئات البرامج
                const cat = item.programCategory || 'غير محدد';
                summary.programCategories[cat] = (summary.programCategories[cat] || 0) + 1;
                
                // الشهور
                if (item.executionDate) {
                    const parts = item.executionDate.split('/');
                    if (parts.length >= 2) {
                        const monthNum = parts[1];
                        const monthNames = {
                            '01': 'يناير', '02': 'فبراير', '03': 'مارس', '04': 'أبريل',
                            '05': 'مايو', '06': 'يونيو', '07': 'يوليو', '08': 'أغسطس',
                            '09': 'سبتمبر', '10': 'أكتوبر', '11': 'نوفمبر', '12': 'ديسمبر'
                        };
                        const month = monthNames[monthNum] || monthNum;
                        if (!summary.months[month]) {
                            summary.months[month] = { count: 0, beneficiaries: 0 };
                        }
                        summary.months[month].count++;
                        summary.months[month].beneficiaries += item.beneficiariesCount || 0;
                    }
                }
                
                // نوع البرنامج
                const type = item.programType || 'حضوري';
                summary.programTypes[type] = (summary.programTypes[type] || 0) + 1;
                
                // الفئات المستهدفة
                const audiences = Array.isArray(item.targetAudience) ? item.targetAudience : [item.targetAudience || 'غير محدد'];
                audiences.forEach(aud => {
                    summary.targetAudiences[aud] = (summary.targetAudiences[aud] || 0) + 1;
                });
            });
            
            // تحويل لنص مقروء للذكاء الاصطناعي
            let contextText = `=== ملخص البيانات من قاعدة البيانات ===\n\n`;
            contextText += `إجمالي البرامج والمناشط: ${summary.totalPrograms}\n`;
            contextText += `إجمالي المستفيدين: ${summary.totalBeneficiaries}\n`;
            contextText += `متوسط المستفيدين لكل نشاط: ${Math.round(summary.totalBeneficiaries / summary.totalPrograms)}\n\n`;
            
            contextText += `=== التصنيفات ===\n`;
            Object.entries(summary.classifications)
                .sort((a, b) => b[1].count - a[1].count)
                .forEach(([cls, data]) => {
                    contextText += `• ${cls}: ${data.count} نشاط، ${data.beneficiaries} مستفيد\n`;
                });
            
            contextText += `\n=== المنفذون (الدعاة) ===\n`;
            Object.entries(summary.executors)
                .sort((a, b) => b[1].count - a[1].count)
                .forEach(([name, data]) => {
                    contextText += `• ${name}: ${data.count} نشاط، ${data.beneficiaries} مستفيد\n`;
                });
            
            contextText += `\n=== الإحصائيات حسب الشهر ===\n`;
            Object.entries(summary.months).forEach(([month, data]) => {
                contextText += `• شهر ${month}: ${data.count} نشاط، ${data.beneficiaries} مستفيد\n`;
            });
            
            contextText += `\n=== أنواع البرامج ===\n`;
            Object.entries(summary.programTypes).forEach(([type, count]) => {
                contextText += `• ${type}: ${count} نشاط\n`;
            });
            
            contextText += `\n=== فئات البرامج ===\n`;
            Object.entries(summary.programCategories)
                .sort((a, b) => b[1] - a[1])
                .forEach(([cat, count]) => {
                    contextText += `• ${cat}: ${count} نشاط\n`;
                });
            
            contextText += `\n=== الفئات المستهدفة ===\n`;
            Object.entries(summary.targetAudiences).forEach(([aud, count]) => {
                contextText += `• ${aud}: ${count} نشاط\n`;
            });
            
            contextText += `\n=== تفاصيل جميع المناشط ===\n`;
            allData.forEach((item, i) => {
                contextText += `${i + 1}. "${item.programName}" | المنفذ: ${item.executorName} | التصنيف: ${item.classification} | التاريخ: ${item.executionDate} | المستفيدين: ${item.beneficiariesCount} | النوع: ${item.programType || 'حضوري'}\n`;
            });
            
            return contextText;
        }

        function addUserMessage(text) {
            const html = `
                <div class="flex gap-3 justify-end">
                    <div class="bg-primary text-white rounded-2xl rounded-tl-none p-3 max-w-[85%]">
                        <p class="text-sm">${escapeHtml(text)}</p>
                    </div>
                </div>
            `;
            elements.aiMessages.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        function addAiMessage(text) {
            const formattedText = formatAiResponse(text);
            const html = `
                <div class="flex gap-3">
                    <div class="w-8 h-8 bg-primary-light rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="material-icons-round text-primary text-sm">auto_awesome</span>
                    </div>
                    <div class="bg-primary-light/30 dark:bg-slate-800 rounded-2xl rounded-tr-none p-3 max-w-[85%]">
                        <div class="text-sm ai-response">${formattedText}</div>
                    </div>
                </div>
            `;
            elements.aiMessages.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        function showTypingIndicator() {
            const html = `
                <div id="typing-indicator" class="flex gap-3">
                    <div class="w-8 h-8 bg-primary-light rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="material-icons-round text-primary text-sm">auto_awesome</span>
                    </div>
                    <div class="bg-primary-light/30 dark:bg-slate-800 rounded-2xl rounded-tr-none p-3">
                        <div class="typing-indicator flex gap-1">
                            <span class="w-2 h-2 bg-primary rounded-full"></span>
                            <span class="w-2 h-2 bg-primary rounded-full"></span>
                            <span class="w-2 h-2 bg-primary rounded-full"></span>
                        </div>
                    </div>
                </div>
            `;
            elements.aiMessages.insertAdjacentHTML('beforeend', html);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        function formatAiResponse(text) {
            // تحويل النص لـ HTML مع تنسيق
            return escapeHtml(text)
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/• /g, '• ');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            elements.aiMessages.scrollTop = elements.aiMessages.scrollHeight;
        }

        // ==================== التحديث التلقائي ====================
        function startAutoRefresh() {
            if (refreshTimer) clearInterval(refreshTimer);
            
            refreshTimer = setInterval(async () => {
                elements.refreshIndicator.classList.remove('hidden');
                await loadData();
                elements.refreshIndicator.classList.add('hidden');
            }, CONFIG.REFRESH_INTERVAL);
        }

        // ==================== أحداث الواجهة ====================
        function initEventListeners() {
            // البحث
            elements.searchInput.addEventListener('input', (e) => {
                searchQuery = e.target.value;
                applyFilters();
            });
            
            // زر الفلترة
            elements.filterBtn.addEventListener('click', () => {
                elements.filterChips.classList.toggle('hidden');
            });
            
            // شرائح الفلترة
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    applyFilters();
                });
            });
            
            // المساعد الذكي
            elements.aiBtn.addEventListener('click', openAiModal);
            elements.closeAi.addEventListener('click', closeAiModal);
            elements.aiModal.addEventListener('click', (e) => {
                if (e.target === elements.aiModal) closeAiModal();
            });
            
            elements.aiSend.addEventListener('click', sendAiMessage);
            elements.aiInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendAiMessage();
            });
        }

        // ==================== التهيئة ====================
        document.addEventListener('DOMContentLoaded', () => {
            initEventListeners();
            loadData();
            startAutoRefresh();
        });
    </script>
</body>
</html>
